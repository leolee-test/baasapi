---
- name: Ensure certificate directory is clean
  file:
    path: "{{ fabricworkdir }}/keyfiles"
    state: "{{ item }}"
  with_items:
    - "absent"
    - "directory"

- name: Ensure certificate directory exists 
  file:
    path: "{{ fabricworkdir }}/keyfiles/channels"
    state: "{{ item }}"
  with_items:
    - "directory"

- name: Create crypto-config file
  template:
    src: "{{ playbook_dir }}/certsetup/templates/crypto-config.j2"
    dest: "{{ fabricworkdir }}/crypto-config.yml"

- name: Create the certificate files
  command: "{{ fabricpath }}/../../bin_{{ fabric.platform }}_{{ fabric.version }}/bin/cryptogen generate --config crypto-config.yml --output keyfiles"
  args:
    chdir: "{{ fabricworkdir }}"

- name: Combine all orgs into one location
  shell: >-
    if [ -d '{{ item }}' ]; then mv {{ item }}/* . && rm -rf {{ item }}; fi
  args:
    chdir: "{{ fabricworkdir }}/keyfiles"
  with_items:
    - "peerOrganizations"
    - "ordererOrganizations"

- name: Rename admin private key
  shell: >-
    ls *_sk | cat -n | while read n f; do cp "$f" "admin_private.key"; done
  args:
    chdir: "{{ fabricworkdir }}/keyfiles/{{ item }}/users/Admin@{{ item }}/msp/keystore"
  with_items: "{{ allorgs }}"

- name: Rename ca private key
  shell: >-
    ls *_sk|cat -n|while read n f; do mv "$f" "ca_private.key"; done
  args:
    chdir: "{{ fabricworkdir }}/keyfiles/{{ item }}/ca"
  with_items: "{{ allorgs }}"

- name: Rename ca tls private key
  shell: >-
    ls *_sk|cat -n|while read n f; do mv "$f" "tlsca_private.key"; done
  args:
    chdir: "{{ fabricworkdir }}/keyfiles/{{ item }}/tlsca"
  with_items: "{{ allorgs }}"

- include_tasks: "{{ playbook_dir }}/pubconn/tasks/apply.yml"
  when: fabric.k8s.exposeserviceport == true

- include_tasks: "{{ playbook_dir }}/priconn/tasks/apply.yml"
  when: fabric.k8s.exposeserviceport == false

- name: Create endorsement policy file
  template:
    src: "{{ playbook_dir }}/certsetup/templates/policy.j2"
    dest: "{{ fabricworkdir }}/keyfiles/policy.json"

- name: Create core.yml file for every peer
  template:
    src: "{{ playbook_dir }}/certsetup/templates/core.j2"
    dest: "{{ fabricworkdir }}/keyfiles/{{ item.org }}/peers/{{ item.name }}.{{ item.org }}/core.yaml"
  with_items: "{{ allpeers }}"

- name: Create config tx file
  template:
    src: "{{ playbook_dir }}/certsetup/templates/configtx.j2"
    dest: "{{ fabricworkdir }}/configtx.yml"

- name: Create the gensis block and channel transaction
  shell: >-
    export FABRIC_CFG_PATH={{ fabricworkdir }} &&
    {{ fabricpath }}/../../bin_{{ fabric.platform }}_{{ fabric.version }}/bin/configtxgen -profile OrdererGenesis
    -outputBlock keyfiles/genesis.block -channelID orderersystemchannel &&
    {{ fabricpath }}/../../bin_{{ fabric.platform }}_{{ fabric.version }}/bin/configtxgen -profile OrgChannel
    -outputCreateChannelTx keyfiles/default.tx -channelID default
  args:
    chdir: "{{ fabricworkdir }}"
  when: allorderers | length > 0

- name: Create org join request json file
  shell: >-
    export FABRIC_CFG_PATH={{ fabricworkdir }} &&
    {{ fabricpath }}/../../bin_{{ fabric.platform }}_{{ fabric.version }}/bin/configtxgen -printOrg {{ item }} > keyfiles/{{item}}/JoinRequest_{{item}}.json  &&
    {{ fabricpath }}/../../bin_{{ fabric.platform }}_{{ fabric.version }}/bin/configtxgen -profile OrgChannel -outputAnchorPeersUpdate keyfiles/{{ item }}anchors.tx -channelID default -asOrg {{ item }} 
  args:
    chdir: "{{ fabricworkdir }}"
  when: peerorgs | length > 0
  with_items: "{{ peerorgs }}"

- name: Create ca config file
  template:
    src: "{{ playbook_dir }}/certsetup/templates/fabric-ca-server-config.j2"
    dest: "{{ fabricworkdir }}/keyfiles/{{ item.org }}/ca/fabric-ca-server-config.yaml"
  with_items: "{{ allcas }}"

- name: Create a zip file of all certificates
  archive:
    path: "{{ fabricworkdir }}/keyfiles"
    dest: "{{ fabricworkdir }}/certs.tgz"
